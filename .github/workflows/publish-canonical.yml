name: Publish canonical config to S3 (via MCP)

on:
  push:
    branches:
      - config/live
    paths:
      - "config/**"

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Sanity (show changed files)
        run: |
          echo "Branch: $GITHUB_REF"
          echo "SHA:    $GITHUB_SHA"

      - name: Call MCP publish-canonical
        env:
          MCP_BASE_URL: ${{ secrets.MCP_BASE_URL }}
          MCP_INTERNAL_API_KEY: ${{ secrets.MCP_INTERNAL_API_KEY }}
        run: |
          set -euo pipefail
          : "${MCP_BASE_URL:?Missing secret MCP_BASE_URL}"
          : "${MCP_INTERNAL_API_KEY:?Missing secret MCP_INTERNAL_API_KEY}"

          echo "Calling: ${MCP_BASE_URL}/config/publish-canonical"

          curl -sS -X POST "${MCP_BASE_URL}/config/publish-canonical" \
            -H "content-type: application/json" \
            -H "x-internal-token: ${MCP_INTERNAL_API_KEY}" \
            -d '{}' | tee /tmp/out.json

          echo
          echo "Response:"
          cat /tmp/out.json
          #hard fail if the publish does not work
          jq -e '.error == null' /tmp/out.json >/dev/null

      - name: Notify backend to invalidate cache
        env:
          BACKEND_BASE_URL: ${{ secrets.BACKEND_BASE_URL }}  # e.g. http://54.210.22.147:8080
        run: |
          set -euo pipefail
          : "${BACKEND_BASE_URL:?Missing secret BACKEND_BASE_URL}"

          echo "Notifying backend: ${BACKEND_BASE_URL}/internal/config-updated"

          curl -sS -X POST "${BACKEND_BASE_URL}/internal/config-updated" \
            -H "content-type: application/json" \
            -d '{"env":"live","updated":["ui","policy"],"version":"'"$GITHUB_SHA"'"}' \
            | tee /tmp/backend_notify.json

          echo
          echo "Backend response:"
          cat /tmp/backend_notify.json || true

